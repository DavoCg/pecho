var User = require('models').User;
var jwt = require('jsonwebtoken');
var is = require('is_js');

module.exports = {
    login: function(credentials, callback){
        if(!credentials.email || is.not.email(credentials.email)) return callback(new Error('Email not valid'));
        if(!credentials.password) return callback(new Error('Provide a password'));

        User.findOne({email: credentials.email}, function(err, user){
            if(err) return callback(err);
            if(!user) return callback(null, {statusCode: 401, data: 'User not found'});
            if(!user.isValidPassword(credentials.password)) return  callback(new Error('Oups wrong password'));

            var token = generateToken(user);
            callback(null, {statusCode: 200, data: token});
        });
    },
    logout: function(callback){
        // here we set the token to expirated
        callback(null, {statusCode: 200, data: 'User well loggedOut'});
    }
};

function generateToken(user){
    var secret = 'seCretString97NotTobeHere@';
    var options = {
        expiresInSeconds: 1800,
        ignoreExpiration: true
    };
    return jwt.sign({ user: user }, secret, options);
}